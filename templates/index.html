<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GreenSphere Â· æ¯æ—¥ç»¿è‰²è¡ŒåŠ¨æ‰“å¡ï½œLeafPass & G-Points</title>
    <meta name="description" content="GreenSphere æ˜¯ä¸€ä¸ªé€šè¿‡æ¯æ—¥å°ä»»åŠ¡ã€ç§¯åˆ†å’Œæ•°å­—å¾½ç« ï¼Œå¸®åŠ©ä½ å…»æˆå¯æŒç»­ç”Ÿæ´»ä¹ æƒ¯çš„å¹³å°ã€‚ä¸ç‚’å¸ã€ä¸ç†è´¢ï¼Œåªè®°å½•å’Œå¥–åŠ±çœŸå®çš„ç»¿è‰²è¡ŒåŠ¨ã€‚">
    <meta name="keywords" content="GreenSphere, ç»¿è‰²æ‰“å¡, ä½ç¢³ç”Ÿæ´», ESG, å¯æŒç»­, ç¯ä¿, LeafPass, G-Points, ç»¿è‰²ç§¯åˆ†, ç¢³å‡æ’, ä¸œå—äºš, Green Impact">
    <meta name="author" content="GreenSphere">
    <!-- ç§»åŠ¨ç«¯ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph / Social åˆ†äº« -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="GreenSphere Â· æ¯æ—¥ç»¿è‰²è¡ŒåŠ¨æ‰“å¡">
    <meta property="og:description" content="ç”¨å‡ åˆ†é’Ÿçš„å°è¡ŒåŠ¨ï¼Œç§¯ç´¯çœŸå®çš„ç»¿è‰²å½±å“åŠ›ã€‚LeafPass å¾½ç«  & G-Points ç§¯åˆ†ï¼Œè®°å½•ä½ çš„æ¯ä¸€æ¬¡ç¯ä¿é€‰æ‹©ã€‚">
    <meta property="og:url" content="https://greensphere.world">
    <meta property="og:site_name" content="GreenSphere">
    <meta property="og:image" content="https://greensphere.worldstatic/og-greensphere.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="GreenSphere Â· æ¯æ—¥ç»¿è‰²è¡ŒåŠ¨æ‰“å¡">
    <meta name="twitter:description" content="å¸®åŠ©ä½ å…»æˆä½è´Ÿæ‹…ã€å¯æŒç»­çš„ç»¿è‰²ç”Ÿæ´»ä¹ æƒ¯ã€‚">
    <meta name="twitter:image" content="https://greensphere.worldstatic/og-greensphere.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/style.css">

</head>

<body>
    <div class="app-shell">
        <div class="topbar">
            <div class="logo-circle"></div>
            <div>
                <div class="app-title">GreenSphere</div>
                <div class="app-subtitle">æ¯å¤©å‡ åˆ†é’Ÿï¼Œæ¢ä¸€ç‚¹çœŸå®çš„ç»¿è‰²æ”¹å˜</div>

            </div>
        </div>

        <div class="card">
            <div class="section-title">å½“å‰ç”¨æˆ·</div>
            <div id="user"></div>
        </div>

        <div class="card">
            <div class="section-title">æˆ‘çš„ç»¿è‰²è¿›åº¦</div>
            <div class="section-desc">è¿™æ˜¯ä½ åœ¨ GreenSphere é‡Œï¼Œå·²ç»èµ°è¿‡çš„ç»¿è‰²è¶³è¿¹ã€‚</div>
            <div id="stats"></div>
        </div>

        <div class="card">
            <div class="section-title">ä»Šå¤©æƒ³å®Œæˆå“ªäº›å°è¡ŒåŠ¨ï¼Ÿ</div>
            <div class="section-desc">å‹¾é€‰ä½ å·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæˆ‘ä»¬è´Ÿè´£å¸®ä½ ã€Œè®°ä½ã€è¿™äº›å¥½ä¹ æƒ¯ã€‚</div>
            <div id="tasks"></div>
        </div>

        <div class="card">
            <div class="section-title">å¶å­å¾½ç«  Â· LeafPass</div>
            <div class="section-desc">è¿ç»­åšæŒå‡ å¤©ï¼Œä½ çš„ç¬¬ä¸€ç‰‡å°å¶å­å°±ä¼šè¢«ç‚¹äº®ã€‚</div>
            <div id="badges"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    let USER_ID = null;

    function showToast(text) {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.classList.add('show');
        setTimeout(() => {
            t.classList.remove('show');
        }, 1800);
    }

    async function initUser() {
        const tg = window.Telegram && window.Telegram.WebApp;
        let telegramId = null;
        let username = null;

        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const u = tg.initDataUnsafe.user;
            telegramId = u.id;
            username = u.username || (u.first_name || '') + ' ' + (u.last_name || '');
            document.getElementById('user').innerText =
                'å½“å‰ç”¨æˆ·ï¼š' + (username || ('TG User ' + telegramId));
        } else {
            telegramId = 1;
            username = 'Local Demo User';
            document.getElementById('user').innerText =
                'å½“å‰ç”¨æˆ·ï¼š' + username + 'ï¼ˆæœ¬åœ°è°ƒè¯•æ¨¡å¼ï¼‰';
        }

        const res = await fetch('/api/init_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                telegram_id: telegramId,
                username: username
            })
        });
        const data = await res.json();
        USER_ID = data.user_id;
    }

    async function loadData() {
        if (!USER_ID) {
            await initUser();
        }

        const res = await fetch('/api/tasks?user_id=' + USER_ID);
        const data = await res.json();
        const stats = data.stats;

        const statsDiv = document.getElementById('stats');
        let html = '';
        html += '<p>ä»Šå¤©ä½ å·²ç»å®Œæˆ ' + stats.today_completed + ' / ' + stats.total_tasks + ' ä¸ªç»¿è‰²å°è¡ŒåŠ¨</p>';
        html += '<p>ç´¯è®¡è·å¾— ' + stats.total_points + ' åˆ† ï½œ å·²è¿ç»­å‚ä¸ ' + stats.streak + ' å¤©</p>';


        if (stats.total_tasks > 0 && stats.today_completed === stats.total_tasks) {
            html += '<p class="all-done">ğŸ‰ ä»Šå¤©çš„ç»¿è‰²ä»»åŠ¡å·²å…¨éƒ¨å®Œæˆï¼</p>';
        }

        statsDiv.innerHTML = html;

        const badgesDiv = document.getElementById('badges');
        if (stats.streak >= 3) {
            badgesDiv.innerHTML = '<div class="badges-list"><span>New Leaf Â· è¿ç»­ 3 å¤©ç»¿è‰²æ‰“å¡</span></div>';

        } else {
            badgesDiv.innerHTML = '<p style="font-size:13px;color:#777;">å†åšæŒå‡ å¤©ï¼Œå°±ä¼šç‚¹äº®ä½ çš„ç¬¬ä¸€æš New Leaf å¶å­å¾½ç« ã€‚</p>';

        }

        const tasksDiv = document.getElementById('tasks');
        tasksDiv.innerHTML = '';
        data.tasks.forEach(t => {
            const btn = document.createElement('button');
            btn.classList.add('task-button');
            const titleSpan = document.createElement('span');
            titleSpan.classList.add('title');
            const metaSpan = document.createElement('span');
            metaSpan.classList.add('meta');
            metaSpan.innerText = 'å®Œæˆå¯è·å¾— +' + t.points + ' åˆ†';

            if (t.completed_today) {
                btn.classList.add('completed');
                titleSpan.innerText = 'âœ… å·²å®Œæˆï¼š' + t.title;
                btn.disabled = true;
            } else {
                titleSpan.innerText = t.title;
                btn.onclick = async () => {
                    await fetch('/api/complete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: USER_ID, task_id: t.id})
                    });
                    showToast('å·²å®Œæˆï¼š' + t.title);
                    await loadData();
                };
            }

            btn.appendChild(titleSpan);
            btn.appendChild(metaSpan);
            tasksDiv.appendChild(btn);
        });
    }

    (async () => {
        await initUser();
        await loadData();
    })();
    </script>
</body>
</html>

<!--
  GreenSphere Telegram WebApp
  ç»“æ„ï¼š
    - app-shell/topbarï¼šå“ç‰ŒåŒº
    - card(å½“å‰ç”¨æˆ· / è¿›åº¦ / ä»Šæ—¥ä»»åŠ¡ / æˆ‘çš„å¾½ç« )
  æ ·å¼å…¥å£ï¼š/static/style.css
-->

